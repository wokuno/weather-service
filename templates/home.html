<!DOCTYPE html>
<html>
<head>
    <title>Weather Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
</head>
<body class="bg-gray-800 text-white">
    <div class="container mx-auto p-10">
        <h1 class="text-4xl font-bold mb-4">Weather Dashboard</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div>
                <h2 class="text-2xl font-semibold mb-2">Latest Weather Data</h2>
                <p class="mb-1">Temperature: <span id="temperature" class="font-bold"></span></p>
                <p>Pressure: <span id="pressure" class="font-bold"></span></p>
            </div>

            <div>
                <h2 class="text-2xl font-semibold mb-2">Historical Weather Data</h2>
                <form method="GET" action="/" class="flex items-center">
                    <label for="duration" class="mr-2">Select Duration:</label>
                    <select name="duration" id="duration" class="bg-gray-700 text-white rounded p-1">
                        <option value="1h" {{ if eq .Duration "1h" }}selected{{ end }}>Past 1 Hour</option>
                        <option value="12h" {{ if eq .Duration "12h" }}selected{{ end }}>Past 12 Hours</option>
                        <option value="24h" {{ if eq .Duration "24h" }}selected{{ end }}>Past 24 Hours</option>
                        <option value="72h" {{ if eq .Duration "72h" }}selected{{ end }}>Past 3 Days</option>
                        <option value="120h" {{ if eq .Duration "120h" }}selected{{ end }}>Past 5 Days</option>
                        <option value="168h" {{ if eq .Duration "168h" }}selected{{ end }}>Past 1 Week</option>
                    </select>
                    <input type="submit" value="Update" class="ml-2 px-4 py-1 bg-blue-500 hover:bg-blue-700 rounded text-white">
                </form>
            </div>
        </div>

        <div id="chart" class="w-full h-64 bg-gray-700 rounded p-4"></div>
    </div>

    <script>
        // Function to update the latest weather data
        async function updateLatestData() {
            await fetch('/data')
                .then(response => response.json())
                .then(data => {
                    const temperature = (data.LatestData.temperature * 9/5) + 32; // Convert temperature from Celsius to Fahrenheit
                    const roundedTemperature = temperature.toFixed(1); // Limit number of digits to 1 decimal place
                    document.getElementById('temperature').textContent = `${roundedTemperature}Â°F`;
                    document.getElementById('pressure').textContent = data.LatestData.pressure;
    
                    // Update the chart
                    updateChart(data.HistoricalData, data.LatestData);
                });
        }
    
        const updateChart = (historicalData, latestData) => {
        // Prepare the data
        const chartData = historicalData.concat([latestData]).map(data => ({
            time: new Date(data.timestamp),
            temperature: (data.temperature * 9/5) + 32 // Convert temperature from Celsius to Fahrenheit
        }));

        // Check if any temperatures are outside the provided range
        const temperatures = chartData.map(data => data.temperature);
        const minTemperature = Math.min(...temperatures);
        const maxTemperature = Math.max(...temperatures);

        // Update the temperature range
        const temperatureRange = {
            min: Math.min(minTemperature, -30), // Minimum temperature (with lower bound of -30)
            max: Math.max(maxTemperature, 90) // Maximum temperature (with upper bound of 90)
        };

        const width = 500;
        const height = 150;

        // Set up the scales
        const xScale = d3.scaleUtc().domain(d3.extent(chartData, d => d.time)).range([0, width]);
        const yScale = d3.scaleLinear().domain([temperatureRange.min, temperatureRange.max]).range([height, 0]);

        // Set up the line generator
        const line = d3.line()
            .x(d => xScale(d.time))
            .y(d => yScale(d.temperature));

        // Select the existing SVG element and update its contents
        const svg = d3.select("#chart").select("svg");
        
        // Update the path
        svg.select("path")
            .datum(chartData)
            .attr("d", line);

        // Update the color scale
        svg.select("linearGradient")
            .select("stop:first-child")
            .attr("offset", `${100 * (temperatureRange.min + 30) / (90 + 30)}%`); // Update the offset of the first stop

        // Update the y-axis scale
        yScale.domain([temperatureRange.min, temperatureRange.max]);

        // Update the y-axis
        svg.select(".y-axis")
            .transition()
            .call(d3.axisLeft(yScale));
        };

    
        // Fetch initial data and update the chart
        updateLatestData();
    
        // Update latest data and chart periodically
        setInterval(() => {
            updateLatestData();
        }, 5000);
    </script>
    
    <script>
        // Gradient colors
        var mainRectGradient = d3.select("body")
          .select("svg")
          .select("defs")
          .append("linearGradient")
          .attr("id", "mainRectGradient")
          .attr("x1", "0%")
          .attr("y1", "0%")
          .attr("x2", "0%")
          .attr("y2", "100%");

        mainRectGradient.append("stop")
          .attr("offset", "0%")
          .attr("stop-color", "red");

        mainRectGradient.append("stop")
          .attr("offset", "50%")
          .attr("stop-color", "green");

        mainRectGradient.append("stop")
          .attr("offset", "100%")
          .attr("stop-color", "blue");
    </script>
    
</body>
</html>
