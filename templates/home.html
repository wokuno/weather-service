<!DOCTYPE html>
<html>
<head>
    <title>Weather Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <h1>Weather Dashboard</h1>

    <h2>Latest Weather Data</h2>
    <p>Temperature: <span id="temperature"></span></p>
    <p>Pressure: <span id="pressure"></span></p>

    <h2>Historical Weather Data</h2>
    <form method="GET" action="/">
        <label for="duration">Select Duration:</label>
        <select name="duration" id="duration">
            <option value="1h" {{ if eq .Duration "1h" }}selected{{ end }}>Past 1 Hour</option>
            <option value="12h" {{ if eq .Duration "12h" }}selected{{ end }}>Past 12 Hours</option>
            <option value="24h" {{ if eq .Duration "24h" }}selected{{ end }}>Past 24 Hours</option>
            <option value="72h" {{ if eq .Duration "72h" }}selected{{ end }}>Past 3 Days</option>
            <option value="120h" {{ if eq .Duration "120h" }}selected{{ end }}>Past 5 Days</option>
            <option value="168h" {{ if eq .Duration "168h" }}selected{{ end }}>Past 1 Week</option>
        </select>
        <input type="submit" value="Update">
    </form>

    <svg id="chart"></svg>

    <script>
        // Function to update the latest weather data
        const updateLatestData = () => {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('temperature').textContent = data.LatestData.Temperature;
                    document.getElementById('pressure').textContent = data.LatestData.Pressure;

                    // Update the chart
                    // updateChart(data.HistoricalData, data.LatestData);
                });
        };

        // Function to update the chart with new data
        const updateChart = (historicalData, latestData) => {
            // Remove the oldest data point from the historical data
            historicalData.shift();

            const timestamps = historicalData.map(d => new Date(d.Timestamp));
            const temperatures = historicalData.map(d => d.Temperature);
            const pressures = historicalData.map(d => d.Pressure);

            // Add the latest data point to the end of the arrays
            timestamps.push(new Date(latestData.Timestamp));
            temperatures.push(latestData.Temperature);
            pressures.push(latestData.Pressure);

            // Chart dimensions
            const width = 800;
            const height = 400;
            const margin = { top: 20, right: 20, bottom: 40, left: 40 };

            // Create x and y scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(timestamps))
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([d3.min(temperatures), d3.max(pressures)])
                .range([height - margin.bottom, margin.top]);

            // Create temperature line generator
            const temperatureLine = d3.line()
                .x((d, i) => xScale(timestamps[i]))
                .y(d => yScale(d))
                .curve(d3.curveMonotoneX);

            // Create pressure line generator
            const pressureLine = d3.line()
                .x((d, i) => xScale(timestamps[i]))
                .y(d => yScale(d))
                .curve(d3.curveMonotoneX);

            // Select the chart SVG element
            const svg = d3.select('#chart')
                .attr('width', width)
                .attr('height', height);

            // Remove the previous chart elements
            svg.selectAll('.line').remove();
            svg.selectAll('.dot').remove();

            // Append temperature line
            svg.append('path')
                .datum(temperatures)
                .attr('class', 'line temperature-line')
                .attr('d', temperatureLine)
                .attr('fill', 'none')
                .attr('stroke', 'red')
                .attr('stroke-width', 2);

            // Append pressure line
            svg.append('path')
                .datum(pressures)
                .attr('class', 'line pressure-line')
                .attr('d', pressureLine)
                .attr('fill', 'none')
                .attr('stroke', 'blue')
                .attr('stroke-width', 2);

            // Append temperature dots
            svg.selectAll('.dot')
                .data(temperatures)
                .enter()
                .append('circle')
                .attr('class', 'dot temperature-dot')
                .attr('cx', (d, i) => xScale(timestamps[i]))
                .attr('cy', d => yScale(d))
                .attr('r', 3)
                .attr('fill', 'red');

            // Append pressure dots
            svg.selectAll('.dot')
                .data(pressures)
                .enter()
                .append('circle')
                .attr('class', 'dot pressure-dot')
                .attr('cx', (d, i) => xScale(timestamps[i]))
                .attr('cy', d => yScale(d))
                .attr('r', 3)
                .attr('fill', 'blue');
        };

        // Fetch initial data and update the chart
        updateLatestData();

        // Update latest data and chart periodically
        setInterval(() => {
            updateLatestData();
        }, 5000);
    </script>
</body>
</html>
