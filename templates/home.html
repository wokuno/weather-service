<!DOCTYPE html>
<html>
<head>
    <title>Weather Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
</head>
<body>
    <h1>Weather Dashboard</h1>

    <h2>Latest Weather Data</h2>
    <p>Temperature: <span id="temperature"></span></p>
    <p>Pressure: <span id="pressure"></span></p>

    <h2>Historical Weather Data</h2>
    <form method="GET" action="/">
        <label for="duration">Select Duration:</label>
        <select name="duration" id="duration">
            <option value="1h" {{ if eq .Duration "1h" }}selected{{ end }}>Past 1 Hour</option>
            <option value="12h" {{ if eq .Duration "12h" }}selected{{ end }}>Past 12 Hours</option>
            <option value="24h" {{ if eq .Duration "24h" }}selected{{ end }}>Past 24 Hours</option>
            <option value="72h" {{ if eq .Duration "72h" }}selected{{ end }}>Past 3 Days</option>
            <option value="120h" {{ if eq .Duration "120h" }}selected{{ end }}>Past 5 Days</option>
            <option value="168h" {{ if eq .Duration "168h" }}selected{{ end }}>Past 1 Week</option>
        </select>
        <input type="submit" value="Update">
    </form>

    <canvas id="chart"></canvas>

    <script>
        // Function to update the latest weather data
        const updateLatestData = () => {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    document.getElementById('temperature').textContent = data.LatestData.Temperature;
                    document.getElementById('pressure').textContent = data.LatestData.Pressure;

                    // Update the chart
                    updateChart(data.HistoricalData, data.LatestData);
                });
        };

        const updateChart = (historicalData, latestData) => {
        const chartData = [];
        const chartLabels = [];
        
        const dateFormat = 'YYYY-MM-DD HH:mm:ss';
        historicalData.forEach((data) => {
            const timestamp = moment(data.Timestamp).utc().format(dateFormat);
            chartData.push({ x: timestamp, y: data.Temperature });
            chartLabels.push(timestamp);
        });
        
        const latestTimestamp = moment(latestData.Timestamp).utc().format(dateFormat);
        chartData.push({ x: latestTimestamp, y: latestData.Temperature });
        chartLabels.push(latestTimestamp);
        
        const ctx = document.getElementById('chart').getContext('2d');
        
        if (!window.chart) {
            window.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                label: 'Temperature',
                data: chartData,
                borderColor: 'red',
                fill: false
                }]
            },
            options: {
                scales: {
                x: {
                    type: 'time',
                    time: {
                    displayFormats: {
                        second: 'HH:mm:ss',
                        minute: 'HH:mm',
                        hour: 'MMM D, HH:mm',
                        day: 'MMM D',
                        week: 'll',
                        month: 'MMM YYYY',
                        quarter: '[Q]Q - YYYY',
                        year: 'YYYY'
                    }
                    },
                    ticks: {
                    source: 'auto'
                    }
                },
                y: {
                    beginAtZero: true
                }
                }
            }
            });
        } else {
            window.chart.data.labels = chartLabels;
            window.chart.data.datasets[0].data = chartData;
            window.chart.update();
        }
        };



        // Fetch initial data and update the chart
        updateLatestData();

        // Update latest data and chart periodically
        setInterval(() => {
            updateLatestData();
        }, 5000);
    </script>
</body>
</html>
